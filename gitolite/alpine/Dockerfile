FROM alpine:latest

MAINTAINER Back Yu <yhfszb@gmail.com>

# If in China, using mirrors
# RUN echo 'http://mirrors.ustc.edu.cn/alpine/v3.4/main' > /etc/apk/repositories

RUN apk update \
	&& apk upgrade \
	&& apk add git \
	&& apk add openssh \
	&& apk add perl \
	&& rm  -rf /tmp/* /var/cache/apk/*

# mkdir
RUN mkdir -p /home/git/bin \
	&& mkdir -p /home/git/.ssh \
	&& mkdir -p /var/run/sshd

RUN cd /home/git; git clone -b v3.6.6 --depth 1 git://github.com/sitaramc/gitolite;

#make sure we get fresh keys
RUN rm -rf /etc/ssh/ssh_host_rsa_key /etc/ssh/ssh_host_dsa_key

# add USER
RUN addgroup git \
	&& adduser -s /bin/sh -D -S -h /home/git -G git git \
	# Unlock git account (as it was with empty password)
 	 && passwd -u git && \
  	# Forbid SSH password auth for git user
  	( \
		echo ""; \
		echo "# Gitolite changes from $(date)"; \
		echo "Match User git"; \
		echo "    PasswordAuthentication no"; \
	) >> /etc/ssh/sshd_config

RUN chown -R git:git /home/git/
RUN chmod 0755 /home/git/ -R

RUN cd /home/git;su git -c "gitolite/install -ln";

# Remove SSH host keys, so they will be generated by /init
RUN rm -f /etc/ssh/ssh_host_*

# Addind volume to repositories directory
VOLUME /home/git/repositories
VOLUME /etc/ssh
VOLUME /home/git/.ssh

ADD ./init.sh /init
RUN chmod +x /init

ENTRYPOINT ["/init", "/usr/sbin/sshd", "-D"]
EXPOSE 22
